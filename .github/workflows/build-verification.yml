name: Build Verification

# ç®€å•çš„ç¼–è¯‘éªŒè¯å·¥ä½œæµ

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# ä»»åŠ¡
jobs:
  build-verification:
    name: Build and Basic Test
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç ï¼Œå…‹éš†ä»£ç åº“
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive' # æ£€å‡ºå­æ¨¡å—
    
    # å®‰è£…æž„å»ºä¾èµ–
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsqlite3-dev \
          libssl-dev \
          libgtest-dev \
          pkg-config
    
    # é…ç½®å’Œæž„å»ºé¡¹ç›®
    - name: Configure and Build
      run: |
        echo "ðŸ”§ Configuring CMake..."
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON
        
        echo "ðŸ—ï¸ Building project..."
        make -j$(nproc)
        
        echo "âœ… Build completed successfully!"
    
    # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
    - name: Verify Executables
      run: |
        cd build
        
        echo "ðŸ“‹ Checking generated executables..."
        ls -la
        
        # æ£€æŸ¥ä¸»ç¨‹åº
        if [ -x "./SwiftChat" ]; then
          echo "âœ… Main executable found: SwiftChat"
          file ./SwiftChat
        else
          echo "âŒ Main executable not found!"
          exit 1
        fi
        
        # æ£€æŸ¥æµ‹è¯•ç¨‹åº
        echo "ðŸ“‹ Checking test executables..."
        cd tests
        test_count=0
        for test in test_*; do
          if [ -x "$test" ]; then
            echo "âœ… Test found: $test"
            test_count=$((test_count + 1))
          fi
        done
        
        if [ $test_count -eq 0 ]; then
          echo "âš ï¸ No test executables found"
        else
          echo "âœ… Found $test_count test executables"
        fi
    
    # è¿è¡ŒåŸºæœ¬æµ‹è¯•
    - name: Run Basic Tests
      run: |
        cd build/tests
        
        echo "ðŸ§ª Running basic tests..."
        failed_tests=0
        total_tests=0
        
        for test in test_*; do
          if [ -x "$test" ]; then
            total_tests=$((total_tests + 1))
            echo "Running $test..."
            
            if timeout 30s ./"$test"; then
              echo "âœ… $test: PASSED"
            else
              echo "âŒ $test: FAILED"
              failed_tests=$((failed_tests + 1))
            fi
          fi
        done
        
        echo "ðŸ“Š Test Summary:"
        echo "   Total tests: $total_tests"
        echo "   Passed: $((total_tests - failed_tests))"
        echo "   Failed: $failed_tests"
        
        if [ $failed_tests -gt 0 ]; then
          echo "âŒ Some tests failed!"
          exit 1
        else
          echo "âœ… All tests passed!"
        fi
    
    # è¿è¡Œå¿«é€ŸåŠŸèƒ½æµ‹è¯•
    - name: Quick Functionality Test
      run: |
        cd build
        
        echo "ðŸš€ Testing main program startup..."
        # ä½¿ç”¨è¶…æ—¶æ¥æµ‹è¯•ç¨‹åºæ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨
        timeout 5s ./SwiftChat --help 2>/dev/null || true
        
        echo "âœ… Basic functionality test completed"
    
    # ç”Ÿæˆæž„å»ºæ‘˜è¦
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ Build Verification Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- Compiler: GCC (Ubuntu)" >> $GITHUB_STEP_SUMMARY
        echo "- Build Type: Debug" >> $GITHUB_STEP_SUMMARY
        echo "- C++ Standard: C++17" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "âœ… **Build verification completed successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build verification failed. Please check the logs above.**" >> $GITHUB_STEP_SUMMARY
        fi
